generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id       Int     @id @default(autoincrement())
  username String  @unique
  password String
  role     String
  name     String?
  email    String?
  phone    String?
  avatar   String?

  messages Message[]

  @@map("users")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  user_id    Int?     @map("user_id")
  username   String?
  action     String
  details    String?
  ip_address String?  @map("ip_address")
  created_at DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

model FactScore {
  id                 Int     @id @default(autoincrement())
  gender             String?
  race_ethnicity     String? @map("race_ethnicity")
  parental_education String? @map("parental_education")
  math               String?
  math_score         Int?    @map("math_score")
  reading            String?
  reading_score      Int?    @map("reading_score")
  writing            String?
  writing_score      Int?    @map("writing_score")

  @@map("fact_scores_15dec")
}

// ==================== MESSAGING MODELS ====================

model Conversation {
  id           Int      @id @default(autoincrement())
  type         String   @default("direct") // 'direct' or 'group'
  name         String?
  group_avatar String?  @map("group_avatar")
  created_at   DateTime @default(now()) @map("created_at")
  updated_at   DateTime @updatedAt @map("updated_at")

  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

model ConversationMember {
  id              Int      @id @default(autoincrement())
  conversation_id Int      @map("conversation_id")
  user_id         Int      @map("user_id")
  role            String   @default("member") // 'admin' or 'member'
  is_hidden       Boolean  @default(false) @map("is_hidden")
  joined_at       DateTime @default(now()) @map("joined_at")

  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@unique([conversation_id, user_id])
  @@map("conversation_members")
}

model Message {
  id              Int       @id @default(autoincrement())
  conversation_id Int       @map("conversation_id")
  sender_id       Int       @map("sender_id")
  content         String
  created_at      DateTime  @default(now()) @map("created_at")
  is_edited       Boolean   @default(false) @map("is_edited")
  edited_at       DateTime? @map("edited_at")
  is_recalled     Boolean   @default(false) @map("is_recalled")
  attachment_url  String?   @map("attachment_url")
  attachment_type String?   @map("attachment_type")

  conversation Conversation    @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender       User            @relation(fields: [sender_id], references: [id])
  statuses     MessageStatus[]
  deletedFor   MessageDelete[]

  @@map("messages")
}

// Track who deleted message for themselves
model MessageDelete {
  id         Int      @id @default(autoincrement())
  message_id Int      @map("message_id")
  user_id    Int      @map("user_id")
  deleted_at DateTime @default(now()) @map("deleted_at")

  message Message @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id])
  @@map("message_deletes")
}

// Tracking: sent -> delivered -> seen
model MessageStatus {
  id           Int       @id @default(autoincrement())
  message_id   Int       @map("message_id")
  user_id      Int       @map("user_id")
  delivered_at DateTime? @map("delivered_at")
  seen_at      DateTime? @map("seen_at")

  message Message @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id])
  @@map("message_statuses")
}
